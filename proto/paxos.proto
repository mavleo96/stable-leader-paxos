syntax="proto3";

package pb;

import "google/protobuf/empty.proto";
import "google/protobuf/wrappers.proto";

option go_package = "github.com/mavleo96/stable-leader-paxos/pb";

service PaxosNode {
    rpc TransferRequest (TransactionRequest) returns (TransactionResponse);

    rpc PrepareRequest (PrepareMessage) returns (AckMessage);
    rpc AcceptRequest (AcceptMessage) returns (AcceptedMessage);
    rpc CommitRequest (CommitMessage) returns (google.protobuf.Empty);

    rpc NewViewRequest (NewViewMessage) returns (stream AcceptedMessage);
    rpc CatchupRequest (CatchupRequestMessage) returns (CatchupMessage);

    rpc PrintLog (google.protobuf.Empty) returns (google.protobuf.Empty);
    rpc PrintDB (google.protobuf.Empty) returns (google.protobuf.Empty);
    rpc PrintStatus (google.protobuf.Int64Value) returns (google.protobuf.Empty);
    rpc PrintView (google.protobuf.Empty) returns (google.protobuf.Empty);

    rpc ChangeNodeStatus (google.protobuf.BoolValue) returns (google.protobuf.Empty);
    rpc KillLeader (google.protobuf.Empty) returns (google.protobuf.Empty);
}

// ---------- TransactionResponse ----------

message TransactionResponse {
    BallotNumber b = 1;
    int64 timestamp = 2;
    string sender = 3;
    bool result = 4;
}

// ---------- TransactionRequest ----------

message TransactionRequest {
    Transaction transaction = 1;
    int64 timestamp = 2;
    string sender = 3;
}

// ---------- Transaction ----------

message Transaction {
    string sender = 1;
    string receiver = 2;
    int64 amount = 3;
}

// ---------- Prepare ----------

message PrepareMessage {
    BallotNumber b = 1;
}

message AckMessage {
    BallotNumber b = 1;
    repeated AcceptedMessage acceptLog = 2;
}

message BallotNumber {
    int64 n = 1;
    string nodeID = 2;
}

// ---------- Accept ----------

message AcceptMessage {
    BallotNumber b = 1;
    int64 sequenceNum = 2;
    TransactionRequest message = 3;
}

message AcceptedMessage {
    BallotNumber b = 1;
    int64 sequenceNum = 2;
    TransactionRequest message = 3;
    string nodeID = 4;
}

// ---------- Commit ----------

message CommitMessage {
    BallotNumber b = 1;
    int64 sequenceNum = 2;
    TransactionRequest message = 3;
}

// ---------- NewView ----------

message NewViewMessage {
    BallotNumber b = 1;
    repeated AcceptMessage acceptLog = 2;
}

// ---------- Catchup ----------

message CatchupRequestMessage {
    string nodeID = 1;
    int64 sequenceNum = 2;
}

message CatchupMessage {
    BallotNumber b = 1;
    repeated CommitMessage commitLog = 2;
}
